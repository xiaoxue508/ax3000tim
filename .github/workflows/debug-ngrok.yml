name: Test Ngrok Manual

on: workflow_dispatch

jobs:
  debug:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@main

      - name: Debug Secret (Check if exists)
        env:
          MY_TOKEN: ${{ secrets.NGROK_TOKEN }}
        run: |
          if [ -z "$MY_TOKEN" ]; then
            echo "âŒ é”™è¯¯ï¼šGitHub æ²¡æœ‰è¯»åˆ° NGROK_TOKENï¼è¯·æ£€æŸ¥ Secret åå­—æ˜¯å¦æ‹¼å†™æ­£ç¡®ã€‚"
            exit 1
          else
            echo "âœ… æˆåŠŸï¼šè¯»åˆ°äº† Tokenï¼"
            echo "Token å‰ä¸¤ä½æ˜¯: ${MY_TOKEN:0:2} (åº”è¯¥æ˜¾ç¤º 2 å’Œå…¶ä»–å­—ç¬¦)"
            echo "Token é•¿åº¦æ˜¯: ${#MY_TOKEN}"
          fi

      - name: Start Ngrok Manually
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
          SSH_PASS: "li199103"
        run: |
          # 1. å®‰è£… Ngrok
          curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | sudo tee /etc/apt/sources.list.d/ngrok.list && sudo apt-get update && sudo apt-get install ngrok
          
          # 2. å†™å…¥é…ç½®
          ngrok config add-authtoken "$NGROK_TOKEN"
          
          # 3. è®¾ç½®ç”¨æˆ·å¯†ç 
          echo "root:$SSH_PASS" | sudo chpasswd
          
          # 4. å¼€å¯ SSH æœåŠ¡
          sudo sed -i 's/^#\?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config
          sudo sed -i 's/^#\?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config
          sudo service sshd restart
          
          # 5. å¯åŠ¨ Ngrok (åå°è¿è¡Œ)
          # æ³¨æ„ï¼šè¿™é‡ŒæŒ‡å®šäº† region jp (æ—¥æœ¬)ï¼Œå¦‚æœä¸è¡Œå¯ä»¥æ¢æˆ hk æˆ– us
          nohup ngrok tcp --region jp 22 &
          
          # 6. ç­‰å¾…å¹¶è·å–è¿æ¥åœ°å€
          echo "æ­£åœ¨è¿æ¥ Ngrok..."
          sleep 10
          echo "=========================================="
          echo "âœ… SSH è¿æ¥å‘½ä»¤ï¼š"
          curl -s http://localhost:4040/api/tunnels | python3 -c "import sys, json; print(json.load(sys.stdin)['tunnels'][0]['public_url'])" | sed 's/tcp:\/\//ssh root@/' | sed 's/:/ -p /'
          echo "ğŸ”‘ å¯†ç : $SSH_PASS"
          echo "=========================================="
          
          # 7. ä¿æŒè¿æ¥ (ç›´åˆ°ä½ åœ¨ SSH é‡Œæ‰§è¡Œ touch /tmp/stop æ‰ä¼šåœæ­¢)
          while [ ! -f /tmp/stop ]; do sleep 10; done
